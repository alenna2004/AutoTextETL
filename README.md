# AutoTextETL - Automated Document Processing Pipeline

**AutoTextETL** — это мощная система автоматизированной обработки документов, предназначенная для извлечения структурированной информации из неструктурированных и полуструктурированных документов (PDF, DOCX, TXT). Приложение предоставляет гибкий конвейер обработки с возможностью настройки под различные форматы документов и бизнес-требования.

---

## 🏗️ **Архитектура проекта**

Проект следует **многоуровневой архитектуре (Layered Architecture)** с четким разделением ответственности между слоями:

```
AutoTextETL/
├── presentation/           # Слой представления (GUI - PyQt6)
│   ├── __init__.py
│   ├── main_window.py              # Главное окно приложения
│   ├── widgets/
│   │   ├── __init__.py
│   │   ├── pipeline_designer.py    # Визуальный конструктор пайплайнов
│   │   ├── script_editor.py        # Редактор скриптов с подсветкой
│   │   ├── scheduler_config.py     # Конфигурация планировщика
│   │   ├── db_connection.py        # Конфигурация подключения к БД
│   │   ├── run_history.py          # История выполнения пайплайнов
│   │   └── document_uploader.py    # Загрузка и анализ документов
│   └── components/
│       ├── __init__.py
│       ├── real_time_logger.py     # Логи в реальном времени
│       └── metadata_inspector.py   # Инспектор метаданных
│
├── application/            # Слой оркестрации (бизнес-логика)
│   ├── __init__.py
│   ├── pipeline_manager.py         # Управление пайплайнами
│   ├── scheduler_service.py        # Планировщик выполнения
│   ├── task_dispatcher.py          # Распределение задач
│   ├── document_executor.py        # Исполнитель документов
│   ├── batch_processor.py          # Пакетная обработка
│   ├── error_recovery.py           # Восстановление после ошибок
│   └── resource_monitor.py         # Мониторинг ресурсов
│
├── domain/                 # Слой домена (чистые сущности и интерфейсы)
│   ├── __init__.py
│   ├── document.py                 # Структура документа
│   ├── chunk.py                    # Структура чанков
│   ├── pipeline.py                 # Конфигурации пайплайнов
│   ├── enums.py                    # Перечисления (LogLevel и др.)
│   └── interfaces.py               # Интерфейсы (IDocumentLoader, IDbExporter и др.)
│
├── infrastructure/         # Слой инфраструктуры (реализации)
│   ├── __init__.py
│   ├── loaders/
│   │   ├── __init__.py
│   │   ├── document_factory.py     # Фабрика загрузчиков
│   │   ├── pdf_loader.py           # Загрузчик PDF
│   │   ├── txt_loader.py           # Загрузчик TXT
│   │   └── docx/
│   │       ├── __init__.py
│   │       ├── docx_loader.py      # Загрузчик DOCX
│   │       └── virtual_paginator.py # Виртуальная пагинация DOCX
│   │
│   ├── processors/
│   │   ├── __init__.py
│   │   ├── line_splitter.py        # Разбиение по строкам
│   │   ├── delimiter_splitter.py   # Разбиение по разделителям
│   │   ├── paragraph_splitter.py   # Разбиение по параграфам
│   │   ├── sentence_splitter.py    # Разбиение по предложениям
│   │   ├── regex_extractor.py      # Извлечение по регуляркам
│   │   └── metadata_propagator.py  # Распространение метаданных
│   │
│   ├── exporters/
│   │   ├── __init__.py
│   │   ├── target_db_exporter.py   # Абстрактный экспортер
│   │   ├── sqlite_exporter.py      # Экспорт в SQLite
│   │   ├── postgres_exporter.py    # Экспорт в PostgreSQL
│   │   ├── mysql_exporter.py       # Экспорт в MySQL
│   │   ├── mongodb_exporter.py     # Экспорт в MongoDB
│   │   └── json_exporter.py        # Экспорт в JSON
│   │
│   ├── database/
│   │   ├── __init__.py
│   │   ├── unified_db.py           # Единая SQLite БД
│   │   ├── config_service.py       # Сервис конфигураций
│   │   ├── script_manager.py       # Управление скриптами
│   │   └── logging_service.py      # Логирование выполнения
│   │
│   ├── security/
│   │   ├── __init__.py
│   │   ├── crypto_service.py       # Шифрование данных
│   │   └── script_sandbox.py       # Песочница для скриптов
│   │
│   └── cpp_core/
│       ├── CMakeLists.txt          # Сборка C++ модулей
│       ├── text_engine.cpp         # Ядро текстовой обработки
│       └── bindings.cpp            # Python bindings
│
├── utilities/              # Утилиты для анализа и конфигурирования
│   ├── __init__.py
│   ├── document_style_analyzer.py  # Анализ стилей документов
│   └── header_filter.py            # Утилита фильтрации заголовков
│
├── resources/              # Ресурсы приложения
│   ├── icons/
│   └── styles.qss
│
├── config/                 # Конфигурационные файлы
│   └── default_settings.json
│
├── tests/                  # Тесты всех уровней
│   ├── unit/
│   ├── integration/
│   └── performance/
│
├── scripts/                # Вспомогательные скрипты
│   └── build_cpp_modules.py
│
├── main.py                 # Точка входа в приложение
├── requirements.txt        # Зависимости
└── README.md               # Документация
```

---

## 📁 **Описание файлов и их назначение**

### **Presentation Layer (presentation/)**

| Файл | Назначение |
|------|------------|
| `main_window.py` | Главное окно приложения с табами и меню |
| `widgets/pipeline_designer.py` | Визуальный конструктор пайплайнов с drag & drop |
| `widgets/script_editor.py` | Редактор пользовательских скриптов с синтаксической подсветкой |
| `widgets/scheduler_config.py` | Конфигурация расписаний выполнения пайплайнов |
| `widgets/db_connection.py` | Настройка подключения к целевым базам данных |
| `widgets/run_history.py` | Просмотр истории выполнения пайплайнов |
| `widgets/document_uploader.py` | Загрузка документов и анализ стилей с настройкой заголовков |
| `components/real_time_logger.py` | Отображение логов выполнения в реальном времени |
| `components/metadata_inspector.py` | Инспектор метаданных чанков и документов |

### **Application Layer (application/)**

| Файл | Назначение |
|------|------------|
| `pipeline_manager.py` | Управление жизненным циклом пайплайнов (создание, обновление, удаление) |
| `scheduler_service.py` | Планировщик выполнения по cron-выражениям |
| `task_dispatcher.py` | Параллельное выполнение задач с распределением ресурсов |
| `document_executor.py` | Исполнитель обработки отдельных документов |
| `batch_processor.py` | Пакетная обработка множества документов |
| `error_recovery.py` | Восстановление после ошибок с различными стратегиями |
| `resource_monitor.py` | Мониторинг использования CPU, памяти, диска |

### **Domain Layer (domain/)**

| Файл | Назначение |
|------|------------|
| `document.py` | Структура документа, страниц, разделов |
| `chunk.py` | Структура текстовых чанков и метаданных |
| `pipeline.py` | Конфигурации пайплайнов, шагов, запусков |
| `enums.py` | Перечисления (LogLevel, PipelineStatus, StepType и др.) |
| `interfaces.py` | Абстрактные интерфейсы (IDocumentLoader, IDbExporter и др.) |

### **Infrastructure Layer (infrastructure/)**

#### **Loaders (infrastructure/loaders/)**

| Файл | Назначение |
|------|------------|
| `document_factory.py` | Фабрика для создания загрузчиков по формату |
| `pdf_loader.py` | Загрузчик PDF с анализом стилей и TOC |
| `txt_loader.py` | Загрузчик TXT с конвертацией в DOCX для анализа |
| `docx/loader.py` | Загрузчик DOCX с анализом стилей и структуры |
| `docx/structure_builder.py` | Построитель структуры из DOCX стилей |
| `docx/virtual_paginator.py` | Виртуальная пагинация для DOCX (нет реальных страниц) |

#### **Processors (infrastructure/processors/)**

| Файл | Назначение |
|------|------------|
| `line_splitter.py` | Разбиение текста на строки |
| `delimiter_splitter.py` | Разбиение по пользовательским разделителям |
| `paragraph_splitter.py` | Разбиение по параграфам |
| `sentence_splitter.py` | Разбиение по предложениям |
| `regex_extractor.py` | Извлечение данных по регулярным выражениям |
| `metadata_propagator.py` | Распространение метаданных по чанкам |

#### **Exporters (infrastructure/exporters/)**

| Файл | Назначение |
|------|------------|
| `target_db_exporter.py` | Абстрактный интерфейс экспортера |
| `sqlite_exporter.py` | Экспорт в SQLite базу данных |
| `postgres_exporter.py` | Экспорт в PostgreSQL базу данных |
| `mysql_exporter.py` | Экспорт в MySQL базу данных |
| `mongodb_exporter.py` | Экспорт в MongoDB базу данных |
| `json_exporter.py` | Экспорт в JSON файлы |

#### **Database (infrastructure/database/)**

| Файл | Назначение |
|------|------------|
| `unified_db.py` | Единая SQLite база для всех данных приложения |
| `config_service.py` | Управление конфигурациями пайплайнов |
| `script_manager.py` | Безопасное хранение и выполнение скриптов |
| `logging_service.py` | Логирование выполнения пайплайнов |

#### **Security (infrastructure/security/)**

| Файл | Назначение |
|------|------------|
| `crypto_service.py` | Шифрование данных и скриптов |
| `script_sandbox.py` | Безопасное выполнение пользовательских скриптов |

### **Utilities (utilities/)**

| Файл | Назначение |
|------|------------|
| `document_style_analyzer.py` | Анализ стилей документа для настройки заголовков |
| `header_filter.py` | Утилита фильтрации заголовков (include/exclude) |

---

## 🏗️ **Архитектура приложения**

### **Многоуровневый монолит (Layered Architecture)**

Приложение использует **четырехуровневую архитектуру** с **инверсией зависимостей**:

```
┌─────────────────────────────────────────┐
│         Presentation Layer              │  ← PyQt6 GUI, пользовательский интерфейс
├─────────────────────────────────────────┤
│        Application Layer                │  ← Бизнес-логика, оркестрация
├─────────────────────────────────────────┤
│          Domain Layer                   │  ← Чистые сущности, интерфейсы
├─────────────────────────────────────────┤
│       Infrastructure Layer              │  ← Внешние интеграции, реализации
└─────────────────────────────────────────┘
```

#### **Presentation Layer (Слой представления)**
- **Отвечает за**: Пользовательский интерфейс, взаимодействие с пользователем
- **Использует**: PyQt6 для GUI
- **Зависит от**: Application Layer
- **Папки**: `presentation/`

#### **Application Layer (Слой приложения)**
- **Отвечает за**: Оркестрацию, координацию между слоями, бизнес-логику
- **Использует**: Интерфейсы из Domain Layer
- **Зависит от**: Domain Layer, Infrastructure Layer
- **Папки**: `application/`

#### **Domain Layer (Слой домена)**
- **Отвечает за**: Чистые бизнес-сущности, интерфейсы, правила
- **Использует**: Только стандартную библиотеку Python
- **Зависит от**: Ничего (независимый слой)
- **Папки**: `domain/`

#### **Infrastructure Layer (Слой инфраструктуры)**
- **Отвечает за**: Реализации интерфейсов, внешние интеграции, базы данных
- **Использует**: Внешние библиотеки (PyMuPDF, python-docx, psycopg2 и др.)
- **Зависит от**: Domain Layer
- **Папки**: `infrastructure/`

---

## 🚀 **Как запустить проект**

### **Требования**
- Python 3.10+
- Windows/Linux/macOS

### **Установка**

```bash
# 1. Клонировать репозиторий
git clone https://github.com/your-username/AutoTextETL.git
cd AutoTextETL

# 2. Создать виртуальное окружение (рекомендуется)
python -m venv venv
source venv/bin/activate  # Linux/MacOS
# или
venv\Scripts\activate     # Windows

# 3. Установить зависимости
pip install -r requirements.txt

# 4. Запустить приложение
python main.py
```


---

## 🔍 **Как использовать анализ стилей документов**

### **1. Автоматическое выделение стилей в окне загрузки**

1. **Открыть окно "Upload Documents"**
2. **Выбрать документ** для анализа (PDF, DOCX, или TXT)
3. **Нажать "Analyze Styles"**
4. **Система автоматически**:
   - Извлекает все уникальные текстовые стили из документа
   - Показывает их в таблице "Document Styles"
   - Отображает информацию о шрифтах (размер, жирность, курсив)
   - Показывает примеры текста для каждого стиля

### **2. Создание конфигурации на основе стилей**

1. **Нажать "Configure Headers"**
2. **Выбрать метод "Detect from Document Styles"**
3. **В таблице "Header Configuration"**:
   - Каждый стиль из анализа появляется в строке
   - Использовать выпадающий список "Header Level" для назначения уровня (Level 1-5)
   - Нажать "Edit Filters" для настройки фильтрации (include/exclude слова, regex)
   - Нажать "Assign Level" для сохранения назначения

### **3. Пример настройки:**

**Документ содержит:**
- Размер шрифта 16px, жирный → Level 1 (Глава)
- Размер шрифта 14px, жирный → Level 2 (Раздел)
- Размер шрифта 12px, жирный → Level 3 (Подраздел)

**Конфигурация:**
- Назначить стиль "16px Bold" → Level 1
- Назначить стиль "14px Bold" → Level 2
- Назначить стиль "12px Bold" → Level 3

---

## ✍️ **Как задать заголовки вручную**

### **1. Переключиться на метод "Define Exact Phrases"**

1. **В окне "Upload Documents"**:
   - Выбрать радио-кнопку "Define Exact Phrases"
   - Таблица "Phrase Assignment" станет видимой

### **2. Добавление фраз вручную**

1. **Нажать "Add Phrase"**
2. **В диалоговом окне указать**:
   - **Header Level**: Уровень заголовка (Level 1-5)
   - **Phrase/Pattern**: Точный текст или регулярное выражение
   - **Case Sensitivity**: Чувствительность к регистру
   - **Type**: Include (для поиска) или Exclude (для пропуска)

### **3. Примеры фраз:**

**Регулярные выражения:**
- `^\d+\.\s+.*$` → "1. Глава", "2. Раздел"
- `^Chapter\s+\d+.*$` → "Chapter 1: Introduction"
- `^(?i)section\s+\d+.*$` → "SECTION 1", "section 2" (без учета регистра)

**Точные фразы:**
- "Executive Summary" → Level 1
- "Introduction" → Level 1
- "Methodology" → Level 2
- "Results" → Level 2

### **4. Сохранение конфигурации**

1. **После настройки заголовков**:
   - Нажать "Save Configuration"
   - Выбрать путь для сохранения (JSON файл)
   - Использовать этот файл для пакетной обработки

---

## 🧪 **Тестирование(еще не реализовано)**

### **Запуск юнит-тестов**
```bash
pytest tests/unit/ -v
```

### **Запуск интеграционных тестов**
```bash
pytest tests/integration/ -v
```

### **Проверка покрытия кода**
```bash
pytest --cov=application --cov=infrastructure --cov=domain tests/
```

---

## 📋 **Функциональные возможности**

### **🔍 Анализ структуры документов**
- **Автоматическое определение заголовков** на основе стилей (шрифт, размер, жирность)
- **Настройка шаблонов заголовков** пользователем через интерфейс
- **Поддержка многоуровневой структуры** (заголовки 1-го, 2-го, 3-го уровней)
- **Фильтрация заголовков** по ключевым словам и регулярным выражениям

### **⚙️ Гибкий конвейер обработки**
- **Визуальный конструктор пайплайнов** с drag-and-drop интерфейсом
- **Более 10 типов процессоров** для обработки текста
- **Пользовательские скрипты** с безопасным выполнением (песочница)
- **Параллельная обработка** с мониторингом ресурсов

### **📅 Автоматизация и планирование**
- **Планировщик по cron** для автоматического запуска пайплайнов
- **Пакетная обработка** большого количества документов
- **Восстановление после ошибок** с несколькими стратегиями
- **Мониторинг выполнения** в реальном времени

### **💾 Экспорт в различные форматы**
- **SQLite** - для локального хранения
- **PostgreSQL/MySQL** - для корпоративных баз данных
- **MongoDB** - для NoSQL сценариев
- **JSON** - для интеграции и обмена данными

### **🔒 Безопасность**
- **Шифрование пользовательских скриптов** в базе данных
- **Песочница выполнения** с ограничениями по времени и памяти
- **Валидация безопасности** скриптов перед выполнением
- **Контроль доступа** к системным ресурсам

### **🎯 Поддерживаемые форматы**
- **PDF** - с сохранением стилей и координат
- **DOCX** - с поддержкой встроенных стилей
- **TXT** - с шаблонным распознаванием структуры


---
